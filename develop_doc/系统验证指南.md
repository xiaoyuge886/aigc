# 系统验证指南

**验证时间：** 2026-01-08
**验证目标：** 确认前端配置与实际运行行为一致

---

## 验证步骤

### Step 1: 重启后端服务

```bash
cd /Users/hehe/pycharm_projects/aigc/backend
# 停止现有服务（如果正在运行）
# 启动后端服务
python main.py
```

**预期日志：**
```
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

### Step 2: 验证数据迁移

**执行 SQL 查询：**
```bash
sqlite3 /Users/hehe/pycharm_projects/aigc/data/sessions.db "
SELECT
    u.id as user_id,
    u.username,
    usc.scenario_ids,
    bs.name as scenario_name
FROM users u
LEFT JOIN user_scenario_configs usc ON u.id = usc.user_id
LEFT JOIN business_scenarios bs ON substr(usc.scenario_ids, 2, 1) = bs.id
WHERE u.is_active = 1
ORDER BY u.id;
"
```

**预期结果：**
```
user_id=1, username=guoyu, scenario_ids=NULL, scenario_name=NULL
user_id=2, username=admin, scenario_ids=["1"], scenario_name=数据分析
user_id=3, username=guoyu2, scenario_ids=[1], scenario_name=数据分析
```

---

### Step 3: 验证后端 API

**测试 API：**
```bash
curl -X GET 'http://localhost:8000/api/v1/platform/users/2/config' \
  -H 'Authorization: Bearer YOUR_ADMIN_TOKEN'
```

**预期响应：**
```json
{
  "user_id": 2,
  "associated_scenario_id": 1,  // ✅ 从 user_scenario_configs.scenario_ids[0] 获取
  "default_allowed_tools": [...],
  "default_model": "sonnet",
  ...
}
```

**检查后端日志：**
```
[getUserConfig] User 2 has scenario_ids in user_scenario_configs: [1]  ✅
```

---

### Step 4: 验证运行时行为

**测试用户：** guoyu2 (user_id=3)

**操作：**
1. 使用 guoyu2 账号登录前端
2. 进入聊天界面
3. 输入问题："系统有多少用户了统计一下"

**预期后端日志：**
```log
2026-01-08 XX:XX:XX | INFO | api.v1.endpoints:event_generator:528 - [session_query_stream] Found scenario_ids in UserScenarioConfigDB: [1]  ✅
2026-01-08 XX:XX:XX | INFO | api.v1.endpoints:event_generator:541 - [session_query_stream] Only one scenario configured, using: 1  ✅
2026-01-08 XX:XX:XX | INFO | services.configuration_manager:merge_agent_config:214 - [ConfigManager] ✅ Scenario 1 has 3 skills: ["10", "8", "1"]  ✅
2026-01-08 XX:XX:XX | INFO | services.agent_service:create_options:548 - [AgentService] ✅ Added skill restriction to system prompt: ['10', '8', '1']  ✅
```

**关键验证点：**
- ✅ 使用 `user_scenario_configs` 表（不是 `user_configs.associated_scenario_id`）
- ✅ 场景ID=1（数据分析）
- ✅ Skills: `['10', '8', '1']`（只有3个，不包含 minio_uploader）

**AI 应该使用：**
- Skill: data-analysis (ID=10)
- Skill: whodb (ID=8)
- Skill: scientific-critical-thinking (ID=1)
- MCP Tools: sqlite_query, sqlite_get_schema, sqlite_get_tables
- Standard Tools: Bash, Read, Write, Edit

---

### Step 5: 验证 Admin 面板

**操作：**
1. 使用 admin 账号登录
2. 进入"管理中心" -> "用户管理"
3. 找到用户 "guoyu2"
4. 点击"用户设置"按钮

**预期显示：**
- **场景配置** 标签页：显示"数据分析"场景被选中 ✅
- **配置来源**：user_scenario_configs 表 ✅

**如果显示不正确：**
1. 打开浏览器开发者工具（F12）
2. 查看 Network 标签
3. 找到 API 请求：`/api/v1/platform/users/3/scenario-config`
4. 检查响应数据

---

## 常见问题排查

### 问题1: 日志显示 "Found associated_scenario_id in user config (backward compatibility)"

**原因：** `user_scenario_configs` 表没有数据，系统fallback到 `user_configs` 表

**解决方法：**
1. 检查数据迁移是否成功
2. 通过 UserSettings 页面重新保存场景配置

**SQL 验证：**
```bash
sqlite3 /Users/hehe/pycharm_projects/aigc/data/sessions.db "
SELECT user_id, scenario_ids FROM user_scenario_configs WHERE user_id = 3;
"
```

---

### 问题2: 日志显示使用了错误的场景（如场景ID=3）

**原因：** `user_scenario_configs.scenario_ids` 包含错误的场景ID

**解决方法：**
```sql
-- 更新为正确的场景ID
UPDATE user_scenario_configs
SET scenario_ids = '[1]'
WHERE user_id = 3;
```

---

### 问题3: Admin 面板显示的场景与实际运行不一致

**原因：** Admin 面板缓存了旧数据

**解决方法：**
1. 刷新 Admin 面板页面
2. 重新点击"用户设置"按钮
3. 检查 API 响应是否包含正确的 scenario_ids

---

### 问题4: Skills 包含多余的 skill（如 minio_uploader）

**原因：** 场景配置错误，或者使用了错误的场景

**解决方法：**
1. 检查场景配置：
   ```sql
   SELECT id, name, skills FROM business_scenarios WHERE id = 1;
   ```
2. 预期结果：
   ```
   id=1, name=数据分析, skills=["10", "8", "1"]
   ```
3. 如果包含其他 skill，更新场景配置：
   ```sql
   UPDATE business_scenarios
   SET skills = '{"skills": ["10", "8", "1"]}'
   WHERE id = 1;
   ```

---

## 成功标准

### ✅ 数据一致性
- 所有用户场景配置都已迁移到 `user_scenario_configs` 表
- `user_configs.associated_scenario_id` 已废弃（保留用于向后兼容）

### ✅ API 一致性
- `GET /api/v1/platform/users/{user_id}/config` 优先返回 `user_scenario_configs` 的数据
- 日志显示使用 `user_scenario_configs` 表

### ✅ 运行时一致性
- 系统使用 `user_scenario_configs.scenario_ids` 加载场景
- 场景ID、Skills、Tools 都符合预期
- AI 行为与场景配置一致

### ✅ 前端一致性
- UserSettings 页面显示正确的场景配置
- Admin 面板显示正确的场景配置
- 保存场景配置后，系统立即生效

---

## 验证清单

- [ ] 数据迁移验证（SQL查询）
- [ ] 后端 API 验证（curl 请求）
- [ ] 运行时行为验证（用户输入测试）
- [ ] Admin 面板验证（前端显示）
- [ ] 日志验证（后端日志检查）

---

**验证完成时间：** ___________
**验证人：** ___________
**验证结果：** ✅ 通过 / ❌ 失败
**备注：** ___________________________________
