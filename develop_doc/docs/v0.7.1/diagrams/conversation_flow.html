<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>对话主链路</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      padding: 40px;
      line-height: 1.5;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 40px;
      color: #1d1d1f;
    }
    .flow-container {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      overflow-x: auto;
      padding: 20px 0;
    }
    .step {
      background: white;
      border-radius: 12px;
      padding: 24px;
      min-width: 200px;
      max-width: 220px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #e5e5e7;
    }
    .step-number {
      width: 32px;
      height: 32px;
      background: #0ea5e9;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      margin: 0 auto 12px;
    }
    .step-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1d1d1f;
      text-align: center;
    }
    .step-desc {
      font-size: 13px;
      color: #86868b;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .step-details {
      font-size: 12px;
      color: #6e6e73;
      background: #f5f5f7;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      line-height: 1.4;
    }
    .step-details-title {
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 4px;
    }
    .arrow {
      color: #86868b;
      font-size: 24px;
      flex-shrink: 0;
      margin-top: 40px;
    }
    .step-highlight {
      background: #e8f4f8;
      border-color: #0ea5e9;
      border-width: 2px;
    }
    .decision-point {
      background: #fff7ed;
      border-color: #f97316;
      border-width: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>一次对话在系统中的完整流转</h1>
    
    <div class="flow-container">
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-title">前端</div>
        <div class="step-desc">用户输入问题</div>
        <div class="step-details">
          <div class="step-details-title">关键操作：</div>
          • ChatInterface 收集输入<br>
          • 可选：文件上传、@提及文件<br>
          • 调用 streamAgentQuery()
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-title">API 入口</div>
        <div class="step-desc">POST /session/query/stream</div>
        <div class="step-details">
          <div class="step-details-title">处理：</div>
          • JWT 解析 user_id<br>
          • 解析 session_id（可选）<br>
          • 创建新 Session（如需要）
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step decision-point">
        <div class="step-number">3</div>
        <div class="step-title">场景决策</div>
        <div class="step-desc">ScenarioMatcher<br>智能匹配场景</div>
        <div class="step-details">
          <div class="step-details-title">决策逻辑：</div>
          • 优先级：请求指定 > 用户配置 > 默认场景<br>
          • 多场景时：调用模型分析用户问题<br>
          • 返回最匹配场景ID<br>
          • 缓存匹配结果
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-title">配置合并</div>
        <div class="step-desc">ConfigurationManager<br>合并各层配置</div>
        <div class="step-details">
          <div class="step-details-title">优先级：</div>
          Request > Session > User ><br>
          Scenario > Global<br>
          <div style="margin-top: 4px;">生成 agent_config：<br>
          • system_prompt<br>
          • allowed_tools<br>
          • temperature/max_tokens</div>
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step step-highlight">
        <div class="step-number">5</div>
        <div class="step-title">Prompt 组合</div>
        <div class="step-desc">PromptComposer<br>注入偏好</div>
        <div class="step-details">
          <div class="step-details-title">组合层级：</div>
          1. 系统默认 Prompt<br>
          2. 场景描述 + 可用场景列表<br>
          3. 场景专属 Prompt<br>
          4. 用户自定义 Prompt<br>
          5. 用户级偏好（如已学习）<br>
          6. Session级偏好（如已学习）<br>
          → 最终 system_prompt
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step">
        <div class="step-number">6</div>
        <div class="step-title">模型 & Skill</div>
        <div class="step-desc">AgentService<br>调用工具</div>
        <div class="step-details">
          <div class="step-details-title">执行流程：</div>
          • 通过 Claude Agent SDK 调用模型<br>
          • 流式接收 TextBlock<br>
          • 自动调用工具（如需要）：<br>
          - TodoWrite（任务管理）<br>
          - PPTX技能（PPT生成）<br>
          - MinIO上传（文件存储）<br>
          • 返回 ToolUseBlock + ToolResultBlock
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step">
        <div class="step-number">7</div>
        <div class="step-title">持久化</div>
        <div class="step-desc">Session / Message<br>保存记录</div>
        <div class="step-details">
          <div class="step-details-title">写入数据：</div>
          • MessageDB：<br>
          - user消息<br>
          - ai消息（text）<br>
          - tool_use/tool_result<br>
          • ConversationTurnConfigDB：<br>
          - 配置快照<br>
          - 场景ID、Prompt预览<br>
          • 文件事件（如生成PPT）
        </div>
      </div>
      <div class="arrow">→</div>
      
      <div class="step">
        <div class="step-number">8</div>
        <div class="step-title">前端展示</div>
        <div class="step-desc">实时渲染回复</div>
        <div class="step-details">
          <div class="step-details-title">展示内容：</div>
          • 流式文本（Markdown渲染）<br>
          • 工具调用可视化<br>
          • TodoList进度展示<br>
          • 文件事件（下载链接）<br>
          • 反馈按钮（点赞/纠正等）
        </div>
      </div>
    </div>
    
    <div style="margin-top: 40px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e5e5e7;">
      <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #1d1d1f;">关键特性：</div>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 13px; color: #6e6e73;">
        <div>
          <strong style="color: #1d1d1f;">自动场景匹配</strong><br>
          用户无需选择场景，系统根据问题自动匹配最合适的场景
        </div>
        <div>
          <strong style="color: #1d1d1f;">偏好注入</strong><br>
          自动将用户/Session偏好融入Prompt，实现个性化响应
        </div>
        <div>
          <strong style="color: #1d1d1f;">工具自动调用</strong><br>
          根据场景和Prompt，自动调用相应技能和工具，对用户透明
        </div>
      </div>
    </div>
  </div>
</body>
</html>
