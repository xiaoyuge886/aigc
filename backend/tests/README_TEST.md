# æµå¼è¾“å‡ºæµ‹è¯•ä½¿ç”¨è¯´æ˜

## è¿è¡Œæ–¹å¼

### 1. åªè¿è¡Œæµå¼æµ‹è¯• (æ¨è)
```bash
cd /Users/hehe/pycharm_projects/aigc/backend
source ../.venv/bin/activate
python tests/run_conversation_test.py --stream
```

### 2. è¿è¡Œæ‰€æœ‰æµ‹è¯• (åŒ…æ‹¬æµå¼)
```bash
python tests/run_conversation_test.py
```

### 3. å…¶ä»–é€‰é¡¹
- `--debug`: ç®€å•çš„å¥åº·æ£€æŸ¥å’Œä¼šè¯åˆ›å»ºæµ‹è¯•
- `--auth`: è¿è¡Œå®Œæ•´çš„è®¤è¯æµ‹è¯•

## æµå¼è¾“å‡ºæ•ˆæœ

è¿è¡Œ `--stream` åï¼Œä½ ä¼šçœ‹åˆ°ï¼š

```
============================================================
Claude Agent API - æµå¼è¾“å‡ºæµ‹è¯•
============================================================

âœ… Server is healthy

============================================================
TEST 2: Single Query Stream (æ— çŠ¶æ€æµå¼æŸ¥è¯¢)
============================================================

ğŸ“ User: What is the capital of France?

ğŸ¤– Assistant (æµå¼å“åº”å¼€å§‹):

--------------------------------------------------
The capital of France is Paris.

âœ… å®Œæˆ: success
ğŸ’° æˆæœ¬: $0.0001

--------------------------------------------------

âœ… æµå¼å“åº”å®Œæˆ
   æ€»chunkæ•°: 3
   æ€»å­—ç¬¦æ•°: 33


============================================================
TEST 3: Streaming Conversation (å®æ—¶æµå¼è¾“å‡º)
============================================================

[Step 1] Creating session...
âœ… Session: abc123

[Turn 1] User: Tell me a very short joke

ğŸ¤– Assistant (æµå¼å“åº”å¼€å§‹):

--------------------------------------------------
Why don't scientists trust atoms?

Because they make up everything!

âœ… å®Œæˆ: success
ğŸ’° æˆæœ¬: $0.0002
â±ï¸  è€—æ—¶: 1234ms
ğŸ”„ è½®æ¬¡: 1

--------------------------------------------------

âœ… æµå¼å“åº”å®Œæˆ
   æ€»chunkæ•°: 5
   æ€»å­—ç¬¦æ•°: 67


============================================================
æµå¼æµ‹è¯•å®Œæˆ!
============================================================
```

## å…³é”®ç‰¹æ€§

1. **å®æ—¶è¾“å‡º**: æ–‡æœ¬ä¼šé€å­—æ˜¾ç¤ºï¼Œå°±åƒChatGPTä¸€æ ·
2. **æ— ç¼“å†²**: ä½¿ç”¨ `flush=True` ç¡®ä¿ç«‹å³æ˜¾ç¤º
3. **å®Œæ•´ä¿¡æ¯**: æ˜¾ç¤ºæˆæœ¬ã€è€—æ—¶ã€è½®æ¬¡ç­‰è¯¦ç»†ä¿¡æ¯
4. **ä¸¤ç§æ¨¡å¼**:
   - æ— çŠ¶æ€æµå¼: `/agent/query/stream`
   - æœ‰çŠ¶æ€æµå¼: `/session/{id}/query/stream`

## æµ‹è¯•çš„ç«¯ç‚¹

| ç«¯ç‚¹ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `POST /api/v1/agent/query` | éæµå¼ | æ— çŠ¶æ€å•æ¬¡æŸ¥è¯¢ |
| `POST /api/v1/agent/query/stream` | æµå¼ | æ— çŠ¶æ€æµå¼æŸ¥è¯¢ |
| `POST /api/v1/session` | - | åˆ›å»ºä¼šè¯ |
| `POST /api/v1/session/{id}/query` | éæµå¼ | ä¼šè¯æŸ¥è¯¢ |
| `POST /api/v1/session/{id}/query/stream` | æµå¼ | ä¼šè¯æµå¼æŸ¥è¯¢ |

## æŠ€æœ¯ç»†èŠ‚

### æµå¼å“åº”æ ¼å¼
```
data: {"type":"data","data":{"content":[{"type":"text","text":"Hello"}]}}

data: {"type":"data","data":{"subtype":"success","total_cost_usd":0.0001}}
```

### å®¢æˆ·ç«¯å¤„ç†
```python
async for line in response.aiter_lines():
    if line.startswith("data: "):
        json_str = line[6:]
        data = json.loads(json_str)
        # å®æ—¶å¤„ç†...
```

### æœåŠ¡ç«¯å®ç°
- ä½¿ç”¨ `AsyncIterator` ç”Ÿæˆå™¨
- é€šè¿‡ SSE (Server-Sent Events) æ¨é€
- æ¯ä¸ª `yield` ç”Ÿæˆä¸€ä¸ª JSON chunk
