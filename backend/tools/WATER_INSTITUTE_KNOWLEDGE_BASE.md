# 水利院知识库搜索工具使用说明

## 概述

水利院知识库搜索工具 (`water_institute_search`) 是一个集成的私有知识库搜索功能，允许 AI 助手搜索水利院的大量报告和研究文档。

**技术说明**：该知识库服务基于 **SerpApi** 兼容接口实现，提供了与 Google Search API 相同的数据格式和查询方式。

## 工具信息

- **工具名称**: `water_institute_search`
- **功能描述**: Search water institute knowledge base for reports and research
- **API 端点**: `http://192.168.1.20:8899/search`
- **方法**: POST
- **接口类型**: SerpApi 兼容接口
- **搜索引擎**: Google Custom Search (通过 SerpApi 封装)

## 使用方式

### 1. 在 Agent 配置中启用工具

在 `agent_service.py` 或相关的配置文件中，确保工具被添加到 `allowed_tools` 列表：

```python
allowed_tools=[
    "Read", "Write", "Edit", "Bash",
    "mcp__custom_tools__water_institute_search",  # 添加这行
    # ... 其他工具
]
```

### 2. 用户提问示例

用户可以通过自然语言提问来搜索知识库：

#### 示例 1: 搜索水库相关信息
```
用户: 搜索密云水库的相关信息
```

AI 会自动调用工具：
```json
{
  "query": "密云水库"
}
```

#### 示例 2: 搜索洪水预警
```
用户: 查找关于洪水预警的报告
```

AI 会自动调用工具：
```json
{
  "query": "洪水预警"
}
```

#### 示例 3: 搜索水资源管理
```
用户: 水资源管理的研究报告有哪些？
```

AI 会自动调用工具：
```json
{
  "query": "水资源管理"
}
```

## API 响应格式

知识库 API 返回的数据结构：

```json
{
  "searchParameters": {
    "q": "密云水库",
    "type": "search",
    "engine": "google",
    "num": 100,
    "hl": "zh-cn",
    "gl": "cn"
  },
  "organic": [
    {
      "title": "密云水库2016年水利工程维修养护项目...",
      "link": "",
      "snippet": "file_name: 密云水库2016年水利工程维修养护项目.pdf\nBelonging Title: 目录 -> 1 综合说明...",
      "displayedLink": "",
      "favicon": ""
    }
  ],
  "totalResults": 98243,
  "took": 2459.69
}
```

## 工具功能特性

### ✅ 已实现功能

1. **异步 HTTP 请求**: 使用 httpx 进行异步请求，不会阻塞其他操作
2. **超时处理**: 30秒超时限制，防止长时间等待
3. **错误处理**:
   - 连接错误提示
   - 超时错误提示
   - JSON 解析错误处理
   - 通用异常捕获
4. **结果格式化**:
   - 显示总结果数
   - 显示搜索耗时
   - 限制返回前10条结果（避免响应过长）
   - 截断过长的摘要（500字符限制）
5. **输入验证**: 检查空查询

### 📊 输出格式

工具返回的结果包含：

```
📚 Water Institute Knowledge Base Search Results

🔍 Query: 密云水库
📊 Found: 98,243 total results (showing top 10)
⏱️ Search time: 2.46s

--- Result 1 ---
📄 Title: 密云水库2016年水利工程维修养护项目-密云水库2016年潮河白河枢纽机闸设施日常维护实施方案A.pdf
🔗 Link:
📝 Summary:
file_name: 密云水库2016年水利工程维修养护项目.pdf
Belonging Title: 目录 -> 1 综合说明 -> 1.1 水库概况
密云水库是京津冀地区防洪和北京城市供水的重要水利枢纽...

--- Result 2 ---
...
```

## 使用场景

### 适用场景

1. **技术报告查询**: 搜索水利工程、水库管理等相关技术报告
2. **研究资料查找**: 查找水利行业的研究论文和分析报告
3. **政策法规查询**: 搜索水利相关的政策文件和法规
4. **案例分析**: 查找特定水库或工程的历史案例
5. **数据参考**: 获取水利项目的数据和参数信息

### 最佳实践

1. **使用具体关键词**:
   - ✅ "密云水库 洪水预警"
   - ❌ "关于水的信息"

2. **使用专业术语**:
   - ✅ "水库调度方案"
   - ❌ "怎么管理水库"

3. **限定范围**:
   - ✅ "南水北调 水质影响"
   - ❌ "南水北调"

## 常见问题

### Q1: 为什么有时候搜索不到结果？

A: 可能的原因：
- 关键词过于宽泛，尝试使用更具体的词汇
- 知识库中确实没有相关内容
- 检查网络连接和知识库服务状态

### Q2: 搜索结果太多如何精确定位？

A:
- 使用更精确的关键词组合
- 添加时间限定词（如"2023年"、"最新"）
- 使用具体的工程名称或技术术语

### Q3: 工具连接失败怎么办？

A: 检查：
1. 知识库服务是否在运行 (192.168.1.20:8899)
2. 网络连接是否正常
3. 防火墙设置是否允许访问

## 技术实现

### 依赖库
- `httpx==0.27.2`: 异步 HTTP 客户端

### 代码位置
- 文件: `/backend/tools/custom_tools.py`
- 函数: `water_institute_search`
- 行号: 约 339-493

### 注册位置
工具已添加到 `get_custom_tools_server()` 函数的 tools 列表中（第516行）。

## 未来改进方向

1. **高级搜索**: 支持时间范围、文件类型等过滤条件
2. **结果排序**: 按相关性、时间等排序选项
3. **批量搜索**: 支持多个关键词同时搜索
4. **结果缓存**: 缓存常见查询结果，提高响应速度
5. **全文下载**: 支持下载完整的PDF文档内容

## 联系方式

如有问题或建议，请联系开发团队。
