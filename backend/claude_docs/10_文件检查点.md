# 使用检查点重新调整文件更改

在代理会话期间跟踪文件更改并将文件恢复到任何先前状态

文件检查点跟踪在代理会话期间通过 Write、Edit 和 NotebookEdit 工具所做的文件修改，允许您将文件回退到任何先前状态。

## 检查点的工作原理

启用文件检查点后，SDK 会在通过 Write、Edit 或 NotebookEdit 工具修改文件之前创建文件备份。

### 支持的工具

| 工具 | 描述 |
| --- | --- |
| Write | 创建新文件或用新内容覆盖现有文件 |
| Edit | 对现有文件的特定部分进行有针对性的编辑 |
| NotebookEdit | 修改 Jupyter 笔记本（`.ipynb` 文件）中的单元格 |

## 实现检查点

### 步骤 1：设置环境变量

```bash
export CLAUDE_CODE_ENABLE_SDK_FILE_CHECKPOINTING=1
```

### 步骤 2：启用检查点并接收检查点 UUID

```python
import asyncio
import os
from claude_agent_sdk import ClaudeSDKClient, ClaudeAgentOptions, UserMessage, ResultMessage

async def main():
    options = ClaudeAgentOptions(
        enable_file_checkpointing=True,
        permission_mode="acceptEdits",
        extra_args={"replay-user-messages": None},  # 接收检查点UUID所必需
        env={**os.environ, "CLAUDE_CODE_ENABLE_SDK_FILE_CHECKPOINTING": "1"}
    )

    checkpoint_id = None
    session_id = None

    # 运行查询并捕获检查点 UUID 和会话 ID
    async with ClaudeSDKClient(options) as client:
        await client.query("Refactor the authentication module")

        # 捕获第一条用户消息 UUID - 这是我们的恢复点
        async for message in client.receive_response():
            if isinstance(message, UserMessage) and message.uuid and not checkpoint_id:
                checkpoint_id = message.uuid
            if isinstance(message, ResultMessage) and not session_id:
                session_id = message.session_id

    # 稍后，回退文件
    if checkpoint_id and session_id:
        async with ClaudeSDKClient(ClaudeAgentOptions(
            enable_file_checkpointing=True,
            resume=session_id
        )) as client:
            await client.query("")  # Empty prompt opens the connection
            async for message in client.receive_response():
                await client.rewind_files(checkpoint_id)
                break
        print(f"Rewound to checkpoint: {checkpoint_id}")

asyncio.run(main())
```

## 常见模式

### 检查点前的危险操作

```python
safe_checkpoint = None

async for message in client.receive_response():
    # 在每个代理轮次开始前更新检查点
    if isinstance(message, UserMessage) and message.uuid:
        safe_checkpoint = message.uuid

    # 根据您的逻辑决定何时回退
    if revert_condition and safe_checkpoint:
        await client.rewind_files(safe_checkpoint)
        break
```

### 多个恢复点

```python
from dataclasses import dataclass
from datetime import datetime

@dataclass
class Checkpoint:
    id: str
    description: str
    timestamp: datetime

checkpoints = []

async for message in client.receive_response():
    if isinstance(message, UserMessage) and message.uuid:
        checkpoints.append(Checkpoint(
            id=message.uuid,
            description=f"After turn {len(checkpoints) + 1}",
            timestamp=datetime.now()
        ))
```

## 限制

| 限制 | 描述 |
| --- | --- |
| 仅 Write/Edit/NotebookEdit 工具 | 通过 Bash 命令所做的更改不会被跟踪 |
| 相同会话 | 检查点与创建它们的会话相关联 |
| 仅文件内容 | 创建、移动或删除目录不会通过回退撤销 |

## 故障排除

### 检查点选项未被识别

更新到最新的 SDK 版本：
- Python: `pip install --upgrade claude-agent-sdk`
- TypeScript: `npm install @anthropic-ai/claude-agent-sdk@latest`

### 用户消息没有 UUID

未设置 `replay-user-messages` 选项。添加：
```python
extra_args={"replay-user-messages": None}
```

## 相关文档

- 会话 - 了解会话ID、恢复对话和会话分叉
- 权限 - 配置Claude可以使用哪些工具
- TypeScript SDK 参考 - 完整的API参考
- Python SDK 参考 - 完整的API参考
