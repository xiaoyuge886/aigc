# 安全部署 AI 代理

关于使用隔离、凭证管理和网络控制来保护 Claude Code 和 Agent SDK 部署的指南

Claude Code 和 Agent SDK 是强大的工具，可以代表您执行代码、访问文件并与外部服务交互。与任何具有这些功能的工具一样，经过深思熟虑的部署可以确保您获得好处，同时保持适当的控制。

## 安全原则

### 安全边界

安全边界将具有不同信任级别的组件分开。

### 最小权限

在需要时，您可以将代理限制为仅执行其特定任务所需的功能：

| 资源 | 限制选项 |
| --- | --- |
| 文件系统 | 仅挂载所需目录，优先使用只读 |
| 网络 | 通过代理限制到特定端点 |
| 凭证 | 通过代理注入而不是直接暴露 |
| 系统功能 | 在容器中删除 Linux 功能 |

### 纵深防御

对于高安全性环境，分层多个控制提供额外保护：
- 容器隔离
- 网络限制
- 文件系统控制
- 代理处的请求验证

## 隔离技术

| 技术 | 隔离强度 | 性能开销 | 复杂性 |
| --- | --- | --- | --- |
| 沙箱运行时 | 良好（安全默认值） | 非常低 | 低 |
| 容器 (Docker) | 取决于设置 | 低 | 中等 |
| gVisor | 优秀（正确设置） | 中等/高 | 中等 |
| VM (Firecracker, QEMU) | 优秀（正确设置） | 高 | 中等/高 |

## 凭证管理

### 代理模式

推荐的方法是在代理的安全边界之外运行一个代理，将凭证注入到传出请求中。

这种模式的好处：
1. 代理永远看不到实际凭证
2. 代理可以强制执行允许的端点的允许列表
3. 代理可以记录所有请求以供审计
4. 凭证存储在一个安全位置

## 文件系统配置

### 只读代码挂载

```bash
docker run -v /path/to/code:/workspace:ro agent-image
```

### 可写位置

对于容器中的临时工作区：
```bash
docker run \
  --read-only \
  --tmpfs /tmp:rw,noexec,nosuid,size=100m \
  --tmpfs /workspace:rw,noexec,size=500m \
  agent-image
```

## 容器安全加固

```bash
docker run \
  --cap-drop ALL \
  --security-opt no-new-privileges \
  --security-opt seccomp=/path/to/seccomp-profile.json \
  --read-only \
  --tmpfs /tmp:rw,noexec,nosuid,size=100m \
  --tmpfs /home/agent:rw,noexec,nosuid,size=500m \
  --network none \
  --memory 2g \
  --cpus 2 \
  --pids-limit 100 \
  --user 1000:1000 \
  -v /path/to/code:/workspace:ro \
  agent-image
```

## 相关文档

- Claude Code 安全文档
- 托管 Agent SDK
- 处理权限
- 沙箱运行时
- AI 代理的致命三角
- OWASP 大型语言模型应用程序前 10 名
- Docker 安全最佳实践
- gVisor 文档
- Firecracker 文档
