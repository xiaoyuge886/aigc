# 使用钩子拦截和控制代理行为

在关键执行点使用钩子拦截和自定义代理行为

钩子让你在关键点拦截代理执行，以添加验证、日志记录、安全控制或自定义逻辑。

## 钩子概述

钩子有两个部分：

1. **回调函数**：钩子触发时运行的逻辑
2. **钩子配置**：告诉 SDK 要钩入哪个事件（如 `PreToolUse`）以及要匹配哪些工具

## 基本示例

以下示例阻止代理修改 `.env` 文件：

```python
import asyncio
from claude_agent_sdk import query, ClaudeAgentOptions, HookMatcher

# 定义一个接收工具调用详情的钩子回调
async def protect_env_files(input_data, tool_use_id, context):
    # 从工具的输入参数中提取文件路径
    file_path = input_data['tool_input'].get('file_path', '')
    file_name = file_path.split('/')[-1]

    # 如果目标是 .env 文件，则阻止操作
    if file_name == '.env':
        return {
            'hookSpecificOutput': {
                'hookEventName': input_data['hook_event_name'],
                'permissionDecision': 'deny',
                'permissionDecisionReason': 'Cannot modify .env files'
            }
        }

    # 返回空对象以允许操作
    return {}

async def main():
    async for message in query(
        prompt="Update the database configuration",
        options=ClaudeAgentOptions(
            hooks={
                # 为 PreToolUse 事件注册钩子
                # 匹配器仅过滤 Write 和 Edit 工具调用
                'PreToolUse': [HookMatcher(matcher='Write|Edit', hooks=[protect_env_files])]
            }
        )
    ):
        print(message)

asyncio.run(main())
```

## 可用的钩子

| 钩子事件 | Python SDK | TypeScript SDK | 触发条件 |
| --- | --- | --- | --- |
| `PreToolUse` | 是 | 是 | 工具调用请求（可以阻止或修改） |
| `PostToolUse` | 是 | 是 | 工具执行结果 |
| `UserPromptSubmit` | 是 | 是 | 用户提示提交 |
| `Stop` | 是 | 是 | 代理执行停止 |
| `SubagentStop` | 是 | 是 | 子代理完成 |
| `PreCompact` | 是 | 是 | 会话压缩请求 |
| `PermissionRequest` | 否 | 是 | 权限对话将显示 |

## 配置钩子

```python
async for message in query(
    prompt="Your prompt",
    options=ClaudeAgentOptions(
        hooks={
            'PreToolUse': [HookMatcher(matcher='Bash', hooks=[my_callback])]
        }
    )
):
    print(message)
```

### 回调函数输入

每个钩子回调接收三个参数：

1. **输入数据**：事件详情
2. **工具使用 ID**：关联 `PreToolUse` 和 `PostToolUse` 事件
3. **上下文**：在 TypeScript 中，包含 `signal` 属性用于取消

### 回调输出

返回对象包含 `hookSpecificOutput` 字段，其中包含你的决定：

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| `permissionDecision` | `'allow'` \| `'deny'` \| `'ask'` | 控制工具是否执行 |
| `permissionDecisionReason` | `string` | 为决定向 Claude 显示的解释 |
| `updatedInput` | `object` | 修改的工具输入（需要 `permissionDecision: 'allow'`） |
| `systemMessage` | `string` | 注入到对话中供 Claude 查看 |

### 常见模式

#### 阻止危险命令

```python
async def block_dangerous_commands(input_data, tool_use_id, context):
    if input_data['hook_event_name'] != 'PreToolUse':
        return {}

    command = input_data['tool_input'].get('command', '')
    if 'rm -rf /' in command:
        return {
            'hookSpecificOutput': {
                'hookEventName': input_data['hook_event_name'],
                'permissionDecision': 'deny',
                'permissionDecisionReason': 'Dangerous command blocked: rm -rf /'
            }
        }
    return {}
```

#### 添加系统消息

```python
async def add_security_reminder(input_data, tool_use_id, context):
    return {
        'systemMessage': 'Remember to follow security best practices.'
    }
```

## 相关文档

- 权限：控制你的代理可以做什么
- TypeScript SDK 参考
- Python SDK 参考
